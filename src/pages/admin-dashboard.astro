---
/**
 * Admin Dashboard
 * Visit: http://localhost:4321/admin-dashboard
 * 
 * Shows admin controls, content stats, and management tools
 */
export const prerender = false;

import Base from '../layouts/Base.astro';
import { supabaseServer } from '../lib/supabase-server';
import UserProfile from '../components/UserProfile';
import UserManagement from '../components/UserManagement';
import ContentStats from '../components/ContentStats';

// Get content stats (with error handling)
let postsCount = 0;
let videosCount = 0;
let booksCount = 0;
let musicCount = 0;
let usersCount = 0;

try {
  const { count: posts } = await supabaseServer
    .from('posts')
    .select('*', { count: 'exact', head: true });
  postsCount = posts || 0;
} catch (error) {
  console.log('Posts table not found, using default count');
}

try {
  const { count: videos } = await supabaseServer
    .from('videos')
    .select('*', { count: 'exact', head: true });
  videosCount = videos || 0;
} catch (error) {
  console.log('Videos table not found, using default count');
}

try {
  const { count: books } = await supabaseServer
    .from('books')
    .select('*', { count: 'exact', head: true });
  booksCount = books || 0;
} catch (error) {
  console.log('Books table not found, using default count');
}

try {
  const { count: music } = await supabaseServer
    .from('music')
    .select('*', { count: 'exact', head: true });
  musicCount = music || 0;
} catch (error) {
  console.log('Music table not found, using default count');
}

try {
  const { count: users } = await supabaseServer
    .from('profiles')
    .select('*', { count: 'exact', head: true });
  usersCount = users || 0;
} catch (error) {
  console.log('Profiles table not found, using default count');
}
---

<Base title="Admin Dashboard | Real & Raw Gospel">
  <div class="container mx-auto px-4 py-12 md:py-16">
    <div class="max-w-6xl mx-auto">
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-amber-100 mb-4">
          Admin Dashboard
        </h1>
        <p class="text-lg text-neutral-300">
          Manage content, users, and site settings
        </p>
      </div>

      <!-- Stats Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-6 mb-12">
        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <div class="text-2xl font-bold text-amber-100">{postsCount || 0}</div>
          <div class="text-sm text-neutral-400">Blog Posts</div>
        </div>
        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <div class="text-2xl font-bold text-amber-100">{videosCount || 0}</div>
          <div class="text-sm text-neutral-400">Videos</div>
        </div>
        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <div class="text-2xl font-bold text-amber-100">{booksCount || 0}</div>
          <div class="text-sm text-neutral-400">Books</div>
        </div>
        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <div class="text-2xl font-bold text-amber-100">{musicCount || 0}</div>
          <div class="text-sm text-neutral-400">Music</div>
        </div>
        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <div class="text-2xl font-bold text-amber-100">{usersCount || 0}</div>
          <div class="text-sm text-neutral-400">Users</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <a 
          href="/admin" 
          class="bg-amber-700 hover:bg-amber-600 text-white font-semibold py-6 px-6 rounded-lg text-center transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-black"
        >
          <div class="text-xl mb-2">üìù</div>
          <div class="font-bold">Content Management</div>
          <div class="text-sm opacity-90">Edit posts, videos, books</div>
        </a>

        <a 
          href="/admin-promote" 
          class="bg-blue-700 hover:bg-blue-600 text-white font-semibold py-6 px-6 rounded-lg text-center transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-black"
        >
          <div class="text-xl mb-2">üë•</div>
          <div class="font-bold">User Management</div>
          <div class="text-sm opacity-90">Promote users to admin</div>
        </a>

        <a 
          href="/api/test-supabase" 
          class="bg-neutral-800 hover:bg-neutral-700 text-neutral-200 font-semibold py-6 px-6 rounded-lg text-center transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-black"
        >
          <div class="text-xl mb-2">üîó</div>
          <div class="font-bold">API Test</div>
          <div class="text-sm opacity-90">Check Supabase connection</div>
        </a>

        <a 
          href="/api/health" 
          class="bg-green-700 hover:bg-green-600 text-white font-semibold py-6 px-6 rounded-lg text-center transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-black"
        >
          <div class="text-xl mb-2">üíö</div>
          <div class="font-bold">Health Check</div>
          <div class="text-sm opacity-90">System status</div>
        </a>
      </div>

      <!-- System Status -->
      <div class="grid md:grid-cols-2 gap-6 mb-12">
        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <h2 class="text-xl font-bold text-amber-100 mb-4">System Status</h2>
          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Database Connection</span>
              <span class="text-green-400 font-semibold">‚úì Connected</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Authentication</span>
              <span class="text-green-400 font-semibold">‚úì Active</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Content Collections</span>
              <span class="text-green-400 font-semibold">‚úì Ready</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Admin Middleware</span>
              <span class="text-green-400 font-semibold">‚úì Protected</span>
            </div>
          </div>
        </div>

        <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
          <h2 class="text-xl font-bold text-amber-100 mb-4">Quick Stats</h2>
          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Total Content</span>
              <span class="text-amber-400 font-semibold">{postsCount + videosCount + booksCount + musicCount}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Active Users</span>
              <span class="text-blue-400 font-semibold">{usersCount}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Blog Posts</span>
              <span class="text-green-400 font-semibold">{postsCount}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-neutral-300">Videos</span>
              <span class="text-purple-400 font-semibold">{videosCount}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6">
        <h2 class="text-xl font-bold text-amber-100 mb-4">Recent Activity</h2>
        <div class="space-y-3">
          <div class="flex items-center gap-3 text-sm text-neutral-300">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span>Admin dashboard loaded successfully</span>
            <span class="text-neutral-500 ml-auto">Just now</span>
          </div>
          <div class="flex items-center gap-3 text-sm text-neutral-300">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
            <span>Content statistics updated</span>
            <span class="text-neutral-500 ml-auto">Just now</span>
          </div>
          <div class="flex items-center gap-3 text-sm text-neutral-300">
            <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
            <span>Admin middleware protection active</span>
            <span class="text-neutral-500 ml-auto">Just now</span>
          </div>
        </div>
      </div>

      <!-- Real-time Content Statistics -->
      <div class="mt-8">
        <ContentStats client:load />
      </div>

      <!-- User Management -->
      <div class="mt-8">
        <UserManagement client:load />
      </div>

      <!-- User Profile Component -->
      <div class="mt-8">
        <UserProfile client:load />
      </div>
    </div>
  </div>
</Base>

