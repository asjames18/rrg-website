---
import Base from '../layouts/Base.astro';
import { supabaseServer } from '../lib/supabase-server';

let error = null;
let user = null;
let profile = null;

try {
  const supabase = supabaseServer(Astro.cookies);
  const { data: { user: userData }, error: userError } = await supabase.auth.getUser();
  
  if (userError) {
    error = `User error: ${userError.message}`;
  } else {
    user = userData;
    
    if (user) {
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
      
      if (profileError) {
        error = `Profile error: ${profileError.message}`;
      } else {
        profile = profileData;
      }
    }
  }
} catch (e) {
  error = `Exception: ${e.message}`;
}
---

<Base title="CMS Test">
  <div class="min-h-screen bg-neutral-950">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-amber-100 mb-4">CMS Test</h1>
      
      {error && (
        <div class="bg-red-900/20 border border-red-700 text-red-200 p-4 rounded-lg mb-4">
          <h2 class="font-bold mb-2">Error:</h2>
          <p>{error}</p>
        </div>
      )}
      
      {user && (
        <div class="bg-green-900/20 border border-green-700 text-green-200 p-4 rounded-lg mb-4">
          <h2 class="font-bold mb-2">User:</h2>
          <p>Email: {user.email}</p>
          <p>ID: {user.id}</p>
        </div>
      )}
      
      {profile && (
        <div class="bg-blue-900/20 border border-blue-700 text-blue-200 p-4 rounded-lg mb-4">
          <h2 class="font-bold mb-2">Profile:</h2>
          <p>Role: {profile.role}</p>
        </div>
      )}
      
      <div class="text-neutral-300">
        <p>This page helps debug CMS authentication issues.</p>
        <p class="mt-2">If you see your role as "admin", the CMS should work.</p>
      </div>
    </div>
  </div>
</Base>
