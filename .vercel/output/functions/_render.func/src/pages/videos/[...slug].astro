---
import Base from '../../layouts/Base.astro';
import UniversalVideoEmbed from '../../components/UniversalVideoEmbed';
import VideoCard from '../../components/VideoCard';
import { SupabaseCMSAPI } from '../../lib/cms/supabase-cms-api';

export const prerender = false; // Changed to false for dynamic content

export async function getStaticPaths() {
  try {
    const result = await SupabaseCMSAPI.getContent({
      type: 'video',
      status: 'published',
      limit: 100
    });
    
    return result.content.map((video) => ({
      params: { slug: video.slug },
      props: { video },
    }));
  } catch (error) {
    
    return [];
  }
}

let { video } = Astro.props;

// Fallback fetch for dynamic paths not present in getStaticPaths (because prerender=false)
if (!video) {
  const slugParam = Array.isArray(Astro.params.slug) ? Astro.params.slug.join('/') : (Astro.params.slug || '');
  if (slugParam) {
    try {
      const fetched = await SupabaseCMSAPI.getContentBySlug(slugParam, { type: 'video', status: 'published' });
      if (fetched) {
        video = fetched as any;
      } else {
        Astro.response.status = 404;
      }
    } catch {
      Astro.response.status = 404;
    }
  } else {
    Astro.response.status = 404;
  }
}

const formattedDate = video
  ? new Date(video.published_at || video.created_at).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
    })
  : '';

const hasBody = !!(video && ((video.body_html && video.body_html.trim().length > 0) || (video.body_md && video.body_md.trim().length > 0)));

function escapeHtml(input: string): string {
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// Minimal Markdown renderer for server-side use without external deps.
function renderBasicMarkdown(markdown: string): string {
  if (!markdown) return '';

  // Normalize line endings
  let md = markdown.replace(/\r\n/g, '\n');

  // Code blocks ``` ```
  md = md.replace(/```([\s\S]*?)```/g, (_m, code) => {
    return `<pre><code>${escapeHtml(code)}</code></pre>`;
  });

  // Inline code `code`
  md = md.replace(/`([^`]+)`/g, (_m, code) => `<code>${escapeHtml(code)}</code>`);

  // Headings ####, ###, ##, #
  md = md
    .replace(/^\s*######\s+(.*)$/gm, '<h6>$1</h6>')
    .replace(/^\s*#####\s+(.*)$/gm, '<h5>$1</h5>')
    .replace(/^\s*####\s+(.*)$/gm, '<h4>$1</h4>')
    .replace(/^\s*###\s+(.*)$/gm, '<h3>$1</h3>')
    .replace(/^\s*##\s+(.*)$/gm, '<h2>$1</h2>')
    .replace(/^\s*#\s+(.*)$/gm, '<h1>$1</h1>');

  // Bold and italics
  md = md
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/__([^_]+)__/g, '<strong>$1</strong>')
    .replace(/_([^_]+)_/g, '<em>$1</em>');

  // Links [text](url)
  md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');

  // Unordered lists
  md = md.replace(/(?:^\s*[-*]\s+.*(?:\n|$))+?/gm, (block) => {
    const items = block
      .trim()
      .split('\n')
      .map((line) => line.replace(/^\s*[-*]\s+/, '').trim())
      .filter(Boolean)
      .map((item) => `<li>${item}</li>`)
      .join('');
    return items ? `<ul>${items}</ul>\n` : block;
  });

  // Paragraphs: wrap leftover text blocks separated by blank lines
  md = md
    .split(/\n{2,}/)
    .map((chunk) => {
      const trimmed = chunk.trim();
      if (!trimmed) return '';
      if (/^<h\d|^<ul|^<pre|^<blockquote|^<table|^<p|^<code/.test(trimmed)) {
        return trimmed;
      }
      // Join single newlines within paragraph
      const joined = trimmed.replace(/\n+/g, ' ');
      return `<p>${joined}</p>`;
    })
    .join('\n');

  return md;
}

// Get related videos (same series or topics)
let relatedVideos = [];
try {
  const allVideosResult = await SupabaseCMSAPI.getContent({
    type: 'video',
    status: 'published',
    limit: 50
  });
  
  // Filter related videos
  relatedVideos = (video ? allVideosResult.content
    .filter((v: any) => v.id !== video.id) : allVideosResult.content)
    .map((v: any) => {
      let relevanceScore = 0;
      
      // Same series gets highest score
      if (video?.metadata?.series && v.metadata?.series) {
        const matchingSeries = video.metadata.series.filter((s: string) => 
          v.metadata.series.includes(s)
        );
        relevanceScore += matchingSeries.length * 10;
      }
      
      // Matching topics
      if (video?.metadata?.topics && v.metadata?.topics) {
        const matchingTopics = video.metadata.topics.filter((t: string) => 
          v.metadata.topics.includes(t)
        );
        relevanceScore += matchingTopics.length * 5;
      }
      
      return { ...v, relevanceScore };
    })
    .filter((v: any) => v.relevanceScore > 0)
    .sort((a: any, b: any) => b.relevanceScore - a.relevanceScore)
    .slice(0, 3);
} catch (error) {
  relatedVideos = [];
}

// Get previous/next videos in series
let seriesNav = { prev: null, next: null };
if (video?.metadata?.series && video.metadata.series.length > 0) {
  try {
    const seriesName = video.metadata.series[0];
    const seriesResult = await SupabaseCMSAPI.getContent({
      type: 'video',
      status: 'published',
      limit: 100
    });
    
    const seriesVideos = seriesResult.content
      .filter((v: any) => v.metadata?.series?.includes(seriesName))
      .sort((a: any, b: any) => 
        new Date(a.published_at || a.created_at).getTime() - 
        new Date(b.published_at || b.created_at).getTime()
      );
    
    const currentIndex = seriesVideos.findIndex((v: any) => v.id === video.id);
    if (currentIndex > 0) {
      seriesNav.prev = seriesVideos[currentIndex - 1];
    }
    if (currentIndex < seriesVideos.length - 1) {
      seriesNav.next = seriesVideos[currentIndex + 1];
    }
  } catch (error) {
    // Ignore errors
  }
}
---

{video ? (
<Base title={video.title} description={`Watch: ${video.title}`}>
  <article class="container mx-auto px-4 py-12 md:py-16 max-w-5xl">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-5xl font-bold mb-4 text-amber-100">
        {video.title}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-sm text-neutral-500 mb-6">
        <time datetime={new Date(video.published_at || video.created_at).toISOString()}>
          {formattedDate}
        </time>
        
        {video.metadata?.series && video.metadata.series.length > 0 && (
          <>
            <span>•</span>
            <span class="text-amber-400">
              Series: {Array.isArray(video.metadata.series) ? video.metadata.series.join(', ') : video.metadata.series}
            </span>
          </>
        )}
      </div>

      {video.metadata?.topics && video.metadata.topics.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-4">
          {Array.isArray(video.metadata.topics) ? video.metadata.topics.map((topic) => (
            <span class="inline-block bg-neutral-800 border border-neutral-700 text-neutral-300 text-sm px-3 py-1.5 rounded">
              {topic}
            </span>
          )) : (
            <span class="inline-block bg-neutral-800 border border-neutral-700 text-neutral-300 text-sm px-3 py-1.5 rounded">
              {video.metadata.topics}
            </span>
          )}
        </div>
      )}
    </header>

    <!-- Video Embed -->
    <div class="mb-8 md:mb-12">
      <UniversalVideoEmbed 
        platform={video.metadata?.platform || 'youtube'}
        videoId={video.metadata?.videoId || ''}
        title={video.title}
        client:load
      />
    </div>

    <!-- Scripture References -->
    {video.metadata?.scriptures && video.metadata.scriptures.length > 0 && (
      <div class="mb-8 bg-amber-900/20 border border-amber-800/50 rounded-lg p-6">
        <h2 class="text-lg font-bold text-amber-100 mb-3">Scripture References</h2>
        <div class="flex flex-wrap gap-2">
          {Array.isArray(video.metadata.scriptures) ? video.metadata.scriptures.map((scripture) => (
            <span class="inline-block bg-neutral-900 border border-amber-800 text-amber-200 text-sm font-medium px-3 py-1.5 rounded">
              {scripture}
            </span>
          )) : (
            <span class="inline-block bg-neutral-900 border border-amber-800 text-amber-200 text-sm font-medium px-3 py-1.5 rounded">
              {video.metadata.scriptures}
            </span>
          )}
        </div>
      </div>
    )}

    <!-- Teaching Notes Content -->
    {hasBody && (
      <div class="prose prose-lg prose-invert max-w-none mb-8">
        <h2 class="text-2xl font-bold text-amber-100 mb-4">Teaching Notes</h2>
        {video.body_html && video.body_html.trim().length > 0
          ? <div set:html={video.body_html} />
          : <div set:html={renderBasicMarkdown(video.body_md)} />}
      </div>
    )}

    <!-- Series Navigation -->
    {(seriesNav.prev || seriesNav.next) && (
      <div class="mt-8 pt-8 border-t border-neutral-800">
        <h3 class="text-lg font-bold text-amber-100 mb-4">Series Navigation</h3>
        <div class="grid md:grid-cols-2 gap-4">
          {seriesNav.prev ? (
            <a 
              href={`/videos/${seriesNav.prev.slug}`}
              class="group flex items-center gap-4 p-4 bg-neutral-900 border border-neutral-800 hover:border-amber-700 rounded-lg transition-colors"
            >
              <svg class="w-6 h-6 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              <div class="flex-1 min-w-0">
                <div class="text-xs text-neutral-500 mb-1">Previous in Series</div>
                <div class="font-semibold text-amber-100 group-hover:text-amber-200 transition-colors line-clamp-2">
                  {seriesNav.prev.title}
                </div>
              </div>
            </a>
          ) : (
            <div></div>
          )}
          
          {seriesNav.next && (
            <a 
              href={`/videos/${seriesNav.next.slug}`}
              class="group flex items-center gap-4 p-4 bg-neutral-900 border border-neutral-800 hover:border-amber-700 rounded-lg transition-colors md:ml-auto"
            >
              <div class="flex-1 min-w-0 text-right">
                <div class="text-xs text-neutral-500 mb-1">Next in Series</div>
                <div class="font-semibold text-amber-100 group-hover:text-amber-200 transition-colors line-clamp-2">
                  {seriesNav.next.title}
                </div>
              </div>
              <svg class="w-6 h-6 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          )}
        </div>
      </div>
    )}

    <!-- Share Buttons -->
    <div class="mt-8 pt-8 border-t border-neutral-800">
      <h3 class="text-lg font-bold text-amber-100 mb-4">Share This Video</h3>
      <div class="flex gap-3">
        <button 
          onclick={`navigator.share ? navigator.share({title: '${video.title}', url: window.location.href}) : navigator.clipboard.writeText(window.location.href)`}
          class="flex items-center gap-2 px-4 py-2 bg-neutral-900 border border-neutral-800 hover:border-amber-700 text-neutral-300 hover:text-amber-200 rounded-lg transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
          <span>Share</span>
        </button>
        <button 
          onclick={`navigator.clipboard.writeText(window.location.href).then(() => alert('Link copied!'))`}
          class="flex items-center gap-2 px-4 py-2 bg-neutral-900 border border-neutral-800 hover:border-amber-700 text-neutral-300 hover:text-amber-200 rounded-lg transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <span>Copy Link</span>
        </button>
      </div>
    </div>

    <!-- Related Videos -->
    {relatedVideos.length > 0 && (
      <div class="mt-12 pt-8 border-t border-neutral-800">
        <h3 class="text-2xl font-bold text-amber-100 mb-6">Related Videos</h3>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedVideos.map((relatedVideo: any) => (
            <VideoCard video={relatedVideo} viewMode="grid" client:load />
          ))}
        </div>
      </div>
    )}

    <!-- Footer / Continue Training -->
    <footer class="mt-12 pt-8 border-t border-neutral-800">
      <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-6 md:p-8">
        <h3 class="text-xl font-bold text-amber-100 mb-3">Continue Training</h3>
        <p class="text-neutral-300 mb-4">
          Keep pressing forward in your walk with YAHUSHA. Explore more teachings and resources.
        </p>
        <div class="flex flex-wrap gap-3">
          <a 
            href="/videos" 
            class="inline-block bg-neutral-800 hover:bg-neutral-700 text-neutral-200 font-semibold px-6 py-3 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-black"
          >
            ← All Videos
          </a>
          <a 
            href="/spiritual-warfare" 
            class="inline-block bg-amber-700 hover:bg-amber-600 text-white font-semibold px-6 py-3 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-black"
          >
            Train for War
          </a>
          <a 
            href="/blog" 
            class="inline-block bg-neutral-800 hover:bg-neutral-700 text-neutral-200 font-semibold px-6 py-3 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-black"
          >
            Read the Blog
          </a>
        </div>
      </div>
    </footer>
  </article>
</Base>
) : (
  <>
    {Astro.response.status = 404}
    <Base title="Not Found" description="Video not found">
      <article class="container mx-auto px-4 py-12 md:py-16 max-w-3xl">
        <h1 class="text-3xl md:text-5xl font-bold mb-4 text-amber-100">Video not found</h1>
        <p class="text-neutral-300 mb-6">The video you’re looking for may have been unpublished or the link is incorrect.</p>
        <a 
          href="/videos" 
          class="inline-block bg-neutral-800 hover:bg-neutral-700 text-neutral-200 font-semibold px-6 py-3 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-black"
        >
          ← Back to Videos
        </a>
      </article>
    </Base>
  </>
)}

