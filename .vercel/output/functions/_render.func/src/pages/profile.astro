---
/**
 * User Profile Page
 * Visit: http://localhost:4321/profile
 * 
 * Users can view and manage their profile, settings, and activity
 * Admins can manage user roles and permissions
 */
import Base from '../layouts/Base.astro';
import ProfileCard from '../components/ProfileCard';
import UserActivity from '../components/UserActivity';
import UserManagement from '../components/UserManagement';
---

<Base title="Profile | Real & Raw Gospel">
  <div class="min-h-screen bg-gradient-to-br from-black via-neutral-900 to-black">
    <div class="container mx-auto px-4 py-12 md:py-16">
      <div class="max-w-6xl mx-auto">
        <!-- Page Header -->
        <div class="text-center mb-12">
          <h1 class="text-4xl md:text-5xl font-bold text-amber-100 mb-6 font-display">
            Your Profile
          </h1>
          <p class="text-xl text-neutral-300 max-w-2xl mx-auto">
            Manage your account settings, view your activity, and access exclusive content.
          </p>
        </div>

        <!-- Profile Overview -->
        <div class="mb-12">
          <div id="user-profile-overview">
            <ProfileCard client:load />
          </div>
        </div>

        <!-- Profile Tabs -->
        <div class="bg-neutral-900/50 backdrop-blur-sm border border-neutral-700/50 rounded-2xl p-8">
          <!-- Tab Navigation -->
          <div class="flex flex-wrap gap-2 mb-8 bg-neutral-800/50 rounded-lg p-1">
            <button 
              id="profile-tab" 
              class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 bg-amber-600 text-white shadow-lg"
            >
              Profile Settings
            </button>
            <button 
              id="activity-tab" 
              class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-neutral-400 hover:text-neutral-200"
            >
              Activity
            </button>
            <button 
              id="preferences-tab" 
              class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-neutral-400 hover:text-neutral-200"
            >
              Preferences
            </button>
            <button 
              id="admin-tab" 
              class="px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-neutral-400 hover:text-neutral-200 hidden"
            >
              Admin Panel
            </button>
          </div>

          <!-- Tab Content -->
          <div id="tab-content">
            <!-- Profile Settings Tab -->
            <div id="profile-content" class="tab-panel">
              <div class="space-y-8">
                <div>
                  <h3 class="text-2xl font-bold text-amber-100 mb-6 font-display">Account Information</h3>
                  <div class="bg-neutral-800/50 border border-neutral-700/50 rounded-xl p-6">
                    <div class="grid md:grid-cols-2 gap-6">
                      <div>
                        <label class="block text-sm font-medium text-neutral-200 mb-2">Email Address</label>
                        <input 
                          type="email" 
                          id="profile-email"
                          class="w-full px-4 py-3 bg-neutral-700/50 border border-neutral-600/50 rounded-lg text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500/50 transition-all duration-200"
                          readonly
                        />
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-neutral-200 mb-2">Account Created</label>
                        <input 
                          type="text" 
                          id="profile-created"
                          class="w-full px-4 py-3 bg-neutral-700/50 border border-neutral-600/50 rounded-lg text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500/50 transition-all duration-200"
                          readonly
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <h3 class="text-2xl font-bold text-amber-100 mb-6 font-display">Security</h3>
                  <div class="bg-neutral-800/50 border border-neutral-700/50 rounded-xl p-6">
                    <div class="space-y-4">
                      <div class="flex items-center justify-between">
                        <div>
                          <h4 class="text-lg font-semibold text-neutral-100">Password</h4>
                          <p class="text-sm text-neutral-400">Keep your account secure</p>
                        </div>
                        <button id="change-password-btn" class="bg-amber-700 hover:bg-amber-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors">
                          Change Password
                        </button>
                      </div>
                      <div class="flex items-center justify-between">
                        <div>
                          <h4 class="text-lg font-semibold text-neutral-100">Two-Factor Authentication</h4>
                          <p class="text-sm text-neutral-400">Add an extra layer of security (Coming Soon)</p>
                        </div>
                        <button disabled class="bg-neutral-700 text-neutral-500 font-semibold px-4 py-2 rounded-lg cursor-not-allowed opacity-50">
                          Enable 2FA
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Activity Tab -->
            <div id="activity-content" class="tab-panel hidden">
              <div id="user-activity">
                <UserActivity client:load />
              </div>
            </div>

            <!-- Preferences Tab -->
            <div id="preferences-content" class="tab-panel hidden">
              <div class="space-y-8">
                <div>
                  <h3 class="text-2xl font-bold text-amber-100 mb-6 font-display">Display Preferences</h3>
                  <div class="bg-neutral-800/50 border border-neutral-700/50 rounded-xl p-6">
                    <div class="space-y-6">
                      <div class="flex items-center justify-between">
                        <div>
                          <h4 class="text-lg font-semibold text-neutral-100">Theme</h4>
                          <p class="text-sm text-neutral-400">Choose your preferred theme</p>
                        </div>
                        <select id="pref-theme" class="bg-neutral-700 border border-neutral-600 text-neutral-200 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500/50">
                          <option value="dark">Dark (Default)</option>
                          <option value="light">Light</option>
                          <option value="auto">Auto</option>
                        </select>
                      </div>
                      <div class="flex items-center justify-between">
                        <div>
                          <h4 class="text-lg font-semibold text-neutral-100">Sacred Names</h4>
                          <p class="text-sm text-neutral-400">Show sacred names in content</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="pref-sacred-names" class="sr-only peer" checked>
                          <div class="w-11 h-6 bg-neutral-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div>
                  <h3 class="text-2xl font-bold text-amber-100 mb-6 font-display">Notifications</h3>
                  <div class="bg-neutral-800/50 border border-neutral-700/50 rounded-xl p-6">
                    <div class="space-y-4">
                      <div class="flex items-center justify-between">
                        <div>
                          <h4 class="text-lg font-semibold text-neutral-100">Email Notifications</h4>
                          <p class="text-sm text-neutral-400">Receive updates about new content</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="pref-email-notifs" class="sr-only peer" checked>
                          <div class="w-11 h-6 bg-neutral-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Save Preferences Button -->
                <div class="flex justify-end">
                  <button id="save-preferences-btn" class="bg-amber-700 hover:bg-amber-600 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
                    Save Preferences
                  </button>
                </div>

                <!-- Success Message -->
                <div id="preferences-success" class="hidden p-4 bg-green-900/30 border border-green-700 text-green-200 rounded-lg">
                  ✓ Preferences saved successfully
                </div>
              </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="admin-content" class="tab-panel hidden">
              <div class="space-y-8">
                <div>
                  <h3 class="text-2xl font-bold text-amber-100 mb-6 font-display">User Management</h3>
                  <div id="admin-user-management">
                    <UserManagement client:load />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div id="password-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-neutral-900 border border-neutral-700 rounded-2xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-amber-100">Change Password</h3>
        <button id="close-password-modal" class="text-neutral-400 hover:text-neutral-200 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <form id="password-change-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-neutral-200 mb-2">New Password</label>
          <input 
            type="password" 
            id="new-password"
            required
            minlength="8"
            class="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            placeholder="Enter new password"
          />
          <p class="text-xs text-neutral-500 mt-1">Minimum 8 characters, must include a number or special character</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-neutral-200 mb-2">Confirm New Password</label>
          <input 
            type="password" 
            id="confirm-password"
            required
            minlength="8"
            class="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            placeholder="Confirm new password"
          />
        </div>

        <div id="password-error" class="hidden p-3 bg-red-900/30 border border-red-700 text-red-200 rounded-lg text-sm"></div>
        <div id="password-success" class="hidden p-3 bg-green-900/30 border border-green-700 text-green-200 rounded-lg text-sm"></div>

        <div class="flex gap-3 pt-4">
          <button 
            type="button"
            id="cancel-password-change"
            class="flex-1 bg-neutral-800 hover:bg-neutral-700 text-neutral-200 font-semibold px-4 py-3 rounded-lg transition-colors"
          >
            Cancel
          </button>
          <button 
            type="submit"
            id="submit-password-change"
            class="flex-1 bg-amber-700 hover:bg-amber-600 text-white font-semibold px-4 py-3 rounded-lg transition-colors"
          >
            Change Password
          </button>
        </div>
      </form>
    </div>
  </div>
</Base>

<script type="module">
  // Tab switching functionality
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[Profile Page] Initializing tabs...');
    
    const tabs = ['profile', 'activity', 'preferences', 'admin'];
    const tabButtons = tabs.map(id => document.getElementById(`${id}-tab`));
    const tabContents = tabs.map(id => document.getElementById(`${id}-content`));

    console.log('[Profile Page] Tab buttons found:', tabButtons.filter(b => b).length);
    console.log('[Profile Page] Tab contents found:', tabContents.filter(c => c).length);

    // Tab click handlers
    tabButtons.forEach((button, index) => {
      if (!button) {
        console.warn(`[Profile Page] Tab button not found for: ${tabs[index]}`);
        return;
      }
      
      button.addEventListener('click', () => {
        console.log(`[Profile Page] Tab clicked: ${tabs[index]}`);
        
        // Remove active state from all tabs
        tabButtons.forEach(btn => {
          btn?.classList.remove('bg-amber-600', 'text-white', 'shadow-lg');
          btn?.classList.add('text-neutral-400', 'hover:text-neutral-200');
        });
        
        // Hide all content
        tabContents.forEach(content => {
          content?.classList.add('hidden');
        });

        // Activate clicked tab
        button.classList.add('bg-amber-600', 'text-white', 'shadow-lg');
        button.classList.remove('text-neutral-400', 'hover:text-neutral-200');
        tabContents[index]?.classList.remove('hidden');

        // Load preferences when switching to preferences tab
        if (tabs[index] === 'preferences') {
          loadPreferences();
        }
        
        console.log(`[Profile Page] Now showing: ${tabs[index]}`);
      });
    });

    console.log('[Profile Page] Tab click handlers attached');

    // Load user profile data (don't let this block tab functionality)
    loadUserProfile().catch(err => {
      console.error('[Profile Page] Error in loadUserProfile:', err);
    });
    
    setupPasswordChange();
    setupPreferencesSave();
    
    console.log('[Profile Page] Initialization complete');
  });

  async function loadUserProfile() {
    try {
      const { getSupabase } = await import('../lib/supabase-browser.ts');
      const supabase = getSupabase();

      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        console.log('[Profile Page] User found:', user.email);
        
        // Populate profile fields
        const emailField = document.getElementById('profile-email');
        const createdField = document.getElementById('profile-created');
        
        if (emailField) emailField.value = user.email || '';
        if (createdField) {
          const createdDate = new Date(user.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          createdField.value = createdDate;
        }

        // Check if user is admin and show admin tab - use maybeSingle to handle missing profile
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .maybeSingle();

        if (profileError) {
          console.warn('[Profile Page] Could not fetch profile from profiles table:', profileError);
          
          // Try user_roles table as fallback
          const { data: userRoles } = await supabase
            .from('user_roles')
            .select('role')
            .eq('user_id', user.id);
            
          if (userRoles && userRoles.some(r => r.role === 'admin')) {
            const adminTab = document.getElementById('admin-tab');
            adminTab?.classList.remove('hidden');
            console.log('[Profile Page] Admin tab shown (from user_roles)');
          }
        } else if (profile?.role === 'admin') {
          const adminTab = document.getElementById('admin-tab');
          adminTab?.classList.remove('hidden');
          console.log('[Profile Page] Admin tab shown (from profiles)');
        }
      } else {
        console.log('[Profile Page] No user found, redirecting to auth');
        // Redirect to auth page if not signed in
        window.location.href = '/auth';
      }
    } catch (error) {
      console.error('[Profile Page] Error loading user profile:', error);
      // Don't stop execution - tabs should still work
    }
  }

  // Password Change Modal
  function setupPasswordChange() {
    const modal = document.getElementById('password-modal');
    const openBtn = document.getElementById('change-password-btn');
    const closeBtn = document.getElementById('close-password-modal');
    const cancelBtn = document.getElementById('cancel-password-change');
    const form = document.getElementById('password-change-form');
    const errorDiv = document.getElementById('password-error');
    const successDiv = document.getElementById('password-success');

    openBtn?.addEventListener('click', () => {
      modal?.classList.remove('hidden');
      form?.reset();
      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');
    });

    const closeModal = () => {
      modal?.classList.add('hidden');
    };

    closeBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);

    // Close modal on outside click
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = document.getElementById('new-password')?.value;
      const confirmPassword = document.getElementById('confirm-password')?.value;
      const submitBtn = document.getElementById('submit-password-change');

      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        if (errorDiv) errorDiv.textContent = 'Passwords do not match';
        errorDiv?.classList.remove('hidden');
        return;
      }

      // Validate password strength
      if (newPassword.length < 8) {
        if (errorDiv) errorDiv.textContent = 'Password must be at least 8 characters long';
        errorDiv?.classList.remove('hidden');
        return;
      }

      if (!/[\d\W]/.test(newPassword)) {
        if (errorDiv) errorDiv.textContent = 'Password must contain at least one number or special character';
        errorDiv?.classList.remove('hidden');
        return;
      }

      // Show loading state
      if (submitBtn) {
        submitBtn.textContent = 'Changing...';
        submitBtn.setAttribute('disabled', 'true');
      }

      try {
        const response = await fetch('/api/user/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to change password');
        }

        if (successDiv) successDiv.textContent = '✓ Password changed successfully';
        successDiv?.classList.remove('hidden');
        
        // Reset form and close modal after 2 seconds
        setTimeout(() => {
          form?.reset();
          closeModal();
        }, 2000);

      } catch (error) {
        if (errorDiv) errorDiv.textContent = error instanceof Error ? error.message : 'Failed to change password';
        errorDiv?.classList.remove('hidden');
      } finally {
        if (submitBtn) {
          submitBtn.textContent = 'Change Password';
          submitBtn.removeAttribute('disabled');
        }
      }
    });
  }

  // Load and Save Preferences
  async function loadPreferences() {
    try {
      const response = await fetch('/api/user/preferences');
      const data = await response.json();

      if (data.preferences) {
        const prefs = data.preferences;
        
        const themeSelect = document.getElementById('pref-theme');
        const sacredNamesCheckbox = document.getElementById('pref-sacred-names');
        const emailNotifsCheckbox = document.getElementById('pref-email-notifs');

        if (themeSelect) themeSelect.value = prefs.theme || 'dark';
        if (sacredNamesCheckbox) sacredNamesCheckbox.checked = prefs.show_sacred_names !== false;
        if (emailNotifsCheckbox) emailNotifsCheckbox.checked = prefs.email_notifications !== false;
      }
    } catch (error) {
      console.error('Failed to load preferences:', error);
    }
  }

  function setupPreferencesSave() {
    const saveBtn = document.getElementById('save-preferences-btn');
    const successDiv = document.getElementById('preferences-success');

    saveBtn?.addEventListener('click', async () => {
      const themeSelect = document.getElementById('pref-theme');
      const sacredNamesCheckbox = document.getElementById('pref-sacred-names');
      const emailNotifsCheckbox = document.getElementById('pref-email-notifs');

      const preferences = {
        theme: themeSelect?.value || 'dark',
        show_sacred_names: sacredNamesCheckbox?.checked || false,
        email_notifications: emailNotifsCheckbox?.checked || false
      };

      // Show loading state
      if (saveBtn) {
        saveBtn.textContent = 'Saving...';
        saveBtn.setAttribute('disabled', 'true');
      }

      try {
        const response = await fetch('/api/user/preferences', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preferences)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to save preferences');
        }

        // Show success message
        successDiv?.classList.remove('hidden');
        setTimeout(() => {
          successDiv?.classList.add('hidden');
        }, 3000);

      } catch (error) {
        alert(error instanceof Error ? error.message : 'Failed to save preferences');
      } finally {
        if (saveBtn) {
          saveBtn.textContent = 'Save Preferences';
          saveBtn.removeAttribute('disabled');
        }
      }
    });
  }
</script>
